<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Admin Panel - Infinitely Weird DevOps</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Space+Grotesk:wght@500;600&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="styles.css" />
    <link rel="stylesheet" href="nav.css" />
    <style>
      .tab-bar { display: flex; gap: 0.5rem; margin-bottom: 1.5rem; flex-wrap: wrap; }
      .tab-btn { border: 1px solid var(--border); border-radius: 12px; padding: 0.5rem 1.2rem; background: transparent; color: var(--text); cursor: pointer; font-family: inherit; font-size: 0.9rem; transition: all 0.2s; }
      .tab-btn.active { background: linear-gradient(120deg, #c084fc, #60a5fa, #34d399); color: var(--bg); font-weight: 600; border-color: transparent; }
      .tab-content { display: none; }
      .tab-content.active { display: block; }
      .user-row, .role-row, .group-row { display: flex; align-items: center; justify-content: space-between; padding: 1rem; border-bottom: 1px solid rgba(255,255,255,0.08); gap: 1rem; flex-wrap: wrap; }
      .user-row:last-child, .role-row:last-child, .group-row:last-child { border-bottom: none; }
      .user-info { flex: 1; min-width: 200px; }
      .user-info h4 { margin: 0; font-size: 1rem; }
      .user-info p { margin: 0.2rem 0 0; color: var(--muted); font-size: 0.85rem; }
      .action-btns { display: flex; gap: 0.4rem; flex-wrap: wrap; }
      .btn-sm { border: none; border-radius: 10px; padding: 0.4rem 0.9rem; font-size: 0.8rem; font-weight: 600; font-family: inherit; cursor: pointer; transition: transform 0.15s; }
      .btn-sm:hover { transform: translateY(-1px); }
      .btn-approve { background: var(--accent-2); color: var(--bg); }
      .btn-deny { background: var(--danger); color: #fff; }
      .btn-edit { background: var(--accent); color: var(--bg); }
      .btn-reset { background: rgba(255,255,255,0.2); color: var(--text); }
      .btn-delete { background: var(--danger); color: #fff; }
      .btn-add { background: linear-gradient(120deg, #c084fc, #60a5fa); color: var(--bg); }
      .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(8px); display: flex; align-items: center; justify-content: center; z-index: 100; }
      .modal { background: rgba(20,20,30,0.95); border: 1px solid var(--border); border-radius: 24px; padding: 2rem; max-width: 500px; width: 90%; backdrop-filter: blur(18px); }
      .modal h3 { margin-top: 0; }
      .badge { display: inline-block; padding: 0.15rem 0.5rem; border-radius: 8px; font-size: 0.75rem; margin: 0.1rem; }
      .badge-role { background: rgba(167,139,250,0.25); color: #c4b5fd; }
      .badge-group { background: rgba(52,211,153,0.25); color: #6ee7b7; }
      .badge-pending { background: rgba(251,191,36,0.25); color: #fcd34d; }
      .badge-approved { background: rgba(52,211,153,0.25); color: #6ee7b7; }
      .chip-container { display: flex; flex-wrap: wrap; gap: 0.3rem; margin-top: 0.5rem; }
      .chip { display: inline-flex; align-items: center; gap: 0.3rem; padding: 0.2rem 0.6rem; border-radius: 8px; font-size: 0.8rem; background: rgba(255,255,255,0.1); }
      .chip button { background: none; border: none; color: var(--danger); cursor: pointer; font-size: 0.9rem; padding: 0; line-height: 1; }
      .empty-state { text-align: center; color: var(--muted); padding: 2rem; }
      .back-link { color: var(--accent); text-decoration: none; font-size: 0.9rem; }
      .back-link:hover { text-decoration: underline; }
      select.inline-select { border-radius: 10px; border: 1px solid rgba(255,255,255,0.2); padding: 0.35rem 0.6rem; background: rgba(5,6,10,0.4); color: var(--text); font-size: 0.8rem; }
    </style>
  </head>
  <body>
    <div class="gradient-bg"></div>
    <script src="nav.js"></script>
    <main id="app">
      <header style="margin-bottom:1.5rem;">
        <p class="eyebrow">Administration</p>
        <h1 style="margin:0.1rem 0 0; font-size:2rem;">Admin Panel</h1>
      </header>

      <div class="tab-bar">
        <button class="tab-btn active" data-tab="pending">ğŸ”” Pending Requests</button>
        <button class="tab-btn" data-tab="users">ğŸ‘¥ All Users</button>
        <button class="tab-btn" data-tab="roles">ğŸ›¡ï¸ Roles</button>
        <button class="tab-btn" data-tab="groups">ğŸ“ Groups</button>
        <button class="tab-btn" data-tab="permissions">ğŸ”‘ Permissions</button>
      </div>

      <!-- PENDING TAB -->
      <section id="tab-pending" class="tab-content active glass-card">
        <h2>Pending Approval</h2>
        <div id="pending-list"></div>
      </section>

      <!-- USERS TAB -->
      <section id="tab-users" class="tab-content glass-card">
        <h2>All Users</h2>
        <div id="users-list"></div>
      </section>

      <!-- ROLES TAB -->
      <section id="tab-roles" class="tab-content glass-card">
        <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:1rem;">
          <h2 style="margin:0;">Roles</h2>
          <button class="btn-sm btn-add" id="add-role-btn">+ New Role</button>
        </div>
        <div id="roles-list"></div>
      </section>

      <!-- GROUPS TAB -->
      <section id="tab-groups" class="tab-content glass-card">
        <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:1rem;">
          <h2 style="margin:0;">Groups</h2>
          <button class="btn-sm btn-add" id="add-group-btn">+ New Group</button>
        </div>
        <div id="groups-list"></div>
      </section>

      <!-- PERMISSIONS TAB -->
      <section id="tab-permissions" class="tab-content glass-card">
        <h2>Permissions by Role</h2>
        <p style="color:var(--muted);font-size:0.9rem;margin-bottom:1rem;">Select a role to view and manage its permissions. The Administrator role has full access by default.</p>
        <div style="display:flex;gap:0.5rem;align-items:center;margin-bottom:1.5rem;flex-wrap:wrap;">
          <select class="inline-select" id="perm-role-select" style="font-size:0.95rem;padding:0.5rem 0.8rem;">
            <option value="">Choose a roleâ€¦</option>
          </select>
        </div>
        <div id="permissions-panel"></div>
      </section>

      <!-- MODAL CONTAINER -->
      <div id="modal-container"></div>
    </main>

    <script>
      const token = localStorage.getItem('token');
      if (!token) window.location.href = '/login.html';

      async function api(path, options = {}) {
        const res = await fetch(path, {
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
          ...options
        });
        if (res.status === 401 || res.status === 403) {
          alert('Access denied. Redirecting to login.');
          localStorage.removeItem('token');
          window.location.href = '/login.html';
          return;
        }
        return res.json();
      }

      // â”€â”€â”€ TABS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
          btn.classList.add('active');
          document.getElementById('tab-' + btn.dataset.tab).classList.add('active');
        });
      });

      // â”€â”€â”€ MODALS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      function showModal(html) {
        document.getElementById('modal-container').innerHTML = `
          <div class="modal-overlay" onclick="if(event.target===this)closeModal()">
            <div class="modal">${html}</div>
          </div>`;
      }
      function closeModal() {
        document.getElementById('modal-container').innerHTML = '';
      }

      // â”€â”€â”€ PENDING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      async function loadPending() {
        const users = await api('/api/admin/users/pending');
        const el = document.getElementById('pending-list');
        if (!users || !users.length) {
          el.innerHTML = '<div class="empty-state">No pending requests ğŸ‰</div>';
          return;
        }
        el.innerHTML = users.map(u => `
          <div class="user-row">
            <div class="user-info">
              <h4>${u.Username}</h4>
              <p>${u.Email} Â· Registered ${new Date(u.CreatedAt).toLocaleDateString()}</p>
            </div>
            <div class="action-btns">
              <button class="btn-sm btn-approve" onclick="approveUser(${u.UserID})">âœ“ Approve</button>
              <button class="btn-sm btn-deny" onclick="denyUser(${u.UserID})">âœ• Deny</button>
            </div>
          </div>
        `).join('');
      }

      async function approveUser(id) {
        await api(`/api/admin/users/${id}/approve`, { method: 'POST' });
        loadPending();
        loadUsers();
      }

      async function denyUser(id) {
        if (!confirm('Permanently deny and remove this user?')) return;
        await api(`/api/admin/users/${id}/deny`, { method: 'POST' });
        loadPending();
      }

      // â”€â”€â”€ ALL USERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      let allRoles = [];
      let allGroups = [];

      async function loadUsers() {
        const [users, roles, groups] = await Promise.all([
          api('/api/admin/users'),
          api('/api/admin/roles'),
          api('/api/admin/groups')
        ]);
        allRoles = roles || [];
        allGroups = groups || [];
        const el = document.getElementById('users-list');
        if (!users || !users.length) {
          el.innerHTML = '<div class="empty-state">No users found.</div>';
          return;
        }
        el.innerHTML = users.map(u => `
          <div class="user-row">
            <div class="user-info">
              <h4>${u.Username} <span class="badge ${u.IsApproved ? 'badge-approved' : 'badge-pending'}">${u.IsApproved ? 'Approved' : 'Pending'}</span></h4>
              <p>${u.Email} Â· Joined ${new Date(u.CreatedAt).toLocaleDateString()}</p>
              <div style="margin-top:0.3rem;">
                ${u.Roles ? u.Roles.split(', ').map(r => `<span class="badge badge-role">ğŸ›¡ï¸ ${r}</span>`).join('') : '<span style="color:var(--muted);font-size:0.8rem;">No roles</span>'}
                ${u.Groups ? u.Groups.split(', ').map(g => `<span class="badge badge-group">ğŸ“ ${g}</span>`).join('') : ''}
              </div>
            </div>
            <div class="action-btns">
              <button class="btn-sm btn-edit" onclick="editUserModal(${u.UserID}, '${u.Username.replace(/'/g,"\\'")}', '${u.Email.replace(/'/g,"\\'")}')">Edit</button>
              <button class="btn-sm btn-reset" onclick="resetPasswordModal(${u.UserID}, '${u.Username.replace(/'/g,"\\'")}')">Reset PW</button>
              <button class="btn-sm btn-reset" onclick="manageUserAccess(${u.UserID}, '${u.Username.replace(/'/g,"\\'")}')">Roles/Groups</button>
              <button class="btn-sm btn-deny" onclick="denyUser(${u.UserID})">Delete</button>
            </div>
          </div>
        `).join('');
      }

      function editUserModal(id, username, email) {
        showModal(`
          <h3>Edit User</h3>
          <form id="edit-user-form" style="display:flex;flex-direction:column;gap:1rem;">
            <label><span>Username</span><input type="text" id="edit-username" value="${username}" required /></label>
            <label><span>Email</span><input type="email" id="edit-email" value="${email}" required /></label>
            <div class="form-actions">
              <button type="button" class="ghost btn-sm" onclick="closeModal()">Cancel</button>
              <button type="submit" class="btn-sm btn-approve">Save</button>
            </div>
          </form>
        `);
        document.getElementById('edit-user-form').addEventListener('submit', async (e) => {
          e.preventDefault();
          await api(`/api/admin/users/${id}`, { method: 'PUT', body: JSON.stringify({
            username: document.getElementById('edit-username').value,
            email: document.getElementById('edit-email').value
          })});
          closeModal();
          loadUsers();
        });
      }

      function resetPasswordModal(id, username) {
        showModal(`
          <h3>Reset Password â€” ${username}</h3>
          <form id="reset-pw-form" style="display:flex;flex-direction:column;gap:1rem;">
            <label><span>New Password</span><input type="password" id="new-password" minlength="6" required /></label>
            <label><span>Confirm Password</span><input type="password" id="confirm-password" minlength="6" required /></label>
            <div class="form-actions">
              <button type="button" class="ghost btn-sm" onclick="closeModal()">Cancel</button>
              <button type="submit" class="btn-sm btn-approve">Reset</button>
            </div>
          </form>
        `);
        document.getElementById('reset-pw-form').addEventListener('submit', async (e) => {
          e.preventDefault();
          const pw = document.getElementById('new-password').value;
          const confirm = document.getElementById('confirm-password').value;
          if (pw !== confirm) { alert('Passwords do not match.'); return; }
          await api(`/api/admin/users/${id}/reset-password`, { method: 'POST', body: JSON.stringify({ newPassword: pw })});
          closeModal();
          alert('Password reset successfully.');
        });
      }

      async function manageUserAccess(userId, username) {
        const [details, userPerms] = await Promise.all([
          api(`/api/admin/users/${userId}/details`),
          api(`/api/admin/users/${userId}/permissions`)
        ]);
        const userRoleIds = details.roles.map(r => r.RoleID);
        const userGroupIds = details.groups.map(g => g.GroupID);

        showModal(`
          <h3>Manage Access â€” ${username}</h3>
          <div style="margin-bottom:1.5rem;">
            <h4 style="margin:0 0 0.5rem;">Roles</h4>
            <div class="chip-container" id="user-roles-chips">
              ${details.roles.map(r => `<div class="chip"><span class="badge badge-role">${r.RoleName}</span><button onclick="removeUserRole(${userId},${r.RoleID},'${username}')">Ã—</button></div>`).join('')}
            </div>
            <div style="display:flex;gap:0.4rem;margin-top:0.5rem;">
              <select class="inline-select" id="add-role-select">
                <option value="">Add roleâ€¦</option>
                ${allRoles.filter(r => !userRoleIds.includes(r.RoleID)).map(r => `<option value="${r.RoleID}">${r.RoleName}</option>`).join('')}
              </select>
              <button class="btn-sm btn-add" onclick="addUserRole(${userId},'${username}')">Add</button>
            </div>
          </div>
          <div style="margin-bottom:1.5rem;">
            <h4 style="margin:0 0 0.5rem;">Groups</h4>
            <div class="chip-container" id="user-groups-chips">
              ${details.groups.map(g => `<div class="chip"><span class="badge badge-group">${g.GroupName}</span><button onclick="removeUserGroup(${userId},${g.GroupID},'${username}')">Ã—</button></div>`).join('')}
            </div>
            <div style="display:flex;gap:0.4rem;margin-top:0.5rem;">
              <select class="inline-select" id="add-group-select">
                <option value="">Add to groupâ€¦</option>
                ${allGroups.filter(g => !userGroupIds.includes(g.GroupID)).map(g => `<option value="${g.GroupID}">${g.GroupName}</option>`).join('')}
              </select>
              <button class="btn-sm btn-add" onclick="addUserGroup(${userId},'${username}')">Add</button>
            </div>
          </div>
          <div>
            <h4 style="margin:0 0 0.5rem;">Effective Permissions</h4>
            <div style="display:flex;flex-wrap:wrap;gap:0.3rem;">
              ${userPerms && userPerms.length ? userPerms.map(p => `<span class="badge" style="background:rgba(96,165,250,0.2);color:#93c5fd;">ğŸ”‘ ${p.PermissionName}</span>`).join('') : '<span style="color:var(--muted);font-size:0.85rem;">No permissions</span>'}
            </div>
          </div>
          <div class="form-actions" style="margin-top:1.5rem;">
            <button class="ghost btn-sm" onclick="closeModal()">Close</button>
          </div>
        `);
      }

      async function addUserRole(userId, username) {
        const roleId = document.getElementById('add-role-select').value;
        if (!roleId) return;
        await api(`/api/admin/users/${userId}/roles/${roleId}`, { method: 'POST' });
        await loadUsers();
        manageUserAccess(userId, username);
      }
      async function removeUserRole(userId, roleId, username) {
        await api(`/api/admin/users/${userId}/roles/${roleId}`, { method: 'DELETE' });
        await loadUsers();
        manageUserAccess(userId, username);
      }
      async function addUserGroup(userId, username) {
        const groupId = document.getElementById('add-group-select').value;
        if (!groupId) return;
        await api(`/api/admin/users/${userId}/groups/${groupId}`, { method: 'POST' });
        await loadUsers();
        manageUserAccess(userId, username);
      }
      async function removeUserGroup(userId, groupId, username) {
        await api(`/api/admin/users/${userId}/groups/${groupId}`, { method: 'DELETE' });
        await loadUsers();
        manageUserAccess(userId, username);
      }

      // â”€â”€â”€ ROLES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      async function loadRoles() {
        const roles = await api('/api/admin/roles');
        allRoles = roles || [];
        const el = document.getElementById('roles-list');
        if (!roles || !roles.length) {
          el.innerHTML = '<div class="empty-state">No roles created yet.</div>';
          return;
        }
        el.innerHTML = roles.map(r => `
          <div class="role-row">
            <div class="user-info">
              <h4>ğŸ›¡ï¸ ${r.RoleName}</h4>
            </div>
            <div class="action-btns">
              <button class="btn-sm btn-edit" onclick="manageRolePerms(${r.RoleID}, '${r.RoleName}')">Permissions</button>
              <button class="btn-sm btn-deny" onclick="deleteRole(${r.RoleID}, '${r.RoleName}')">Delete</button>
            </div>
          </div>
        `).join('');
      }

      document.getElementById('add-role-btn').addEventListener('click', () => {
        showModal(`
          <h3>Create Role</h3>
          <form id="create-role-form" style="display:flex;flex-direction:column;gap:1rem;">
            <label><span>Role Name</span><input type="text" id="new-role-name" required /></label>
            <div class="form-actions">
              <button type="button" class="ghost btn-sm" onclick="closeModal()">Cancel</button>
              <button type="submit" class="btn-sm btn-approve">Create</button>
            </div>
          </form>
        `);
        document.getElementById('create-role-form').addEventListener('submit', async (e) => {
          e.preventDefault();
          await api('/api/admin/roles', { method: 'POST', body: JSON.stringify({ roleName: document.getElementById('new-role-name').value })});
          closeModal();
          loadRoles();
        });
      });

      async function deleteRole(id, name) {
        if (!confirm(`Delete role "${name}"? This will remove it from all users and groups.`)) return;
        await api(`/api/admin/roles/${id}`, { method: 'DELETE' });
        loadRoles();
        loadUsers();
      }

      // â”€â”€â”€ GROUPS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      async function loadGroups() {
        const groups = await api('/api/admin/groups');
        allGroups = groups || [];
        const el = document.getElementById('groups-list');
        if (!groups || !groups.length) {
          el.innerHTML = '<div class="empty-state">No groups created yet.</div>';
          return;
        }
        el.innerHTML = groups.map(g => `
          <div class="group-row">
            <div class="user-info">
              <h4>ğŸ“ ${g.GroupName}</h4>
              <div style="margin-top:0.3rem;">
                ${g.Roles ? g.Roles.split(', ').map(r => `<span class="badge badge-role">ğŸ›¡ï¸ ${r}</span>`).join('') : '<span style="color:var(--muted);font-size:0.8rem;">No roles assigned</span>'}
              </div>
            </div>
            <div class="action-btns">
              <button class="btn-sm btn-edit" onclick="manageGroupRoles(${g.GroupID}, '${g.GroupName.replace(/'/g,"\\'")}')" >Manage Roles</button>
              <button class="btn-sm btn-deny" onclick="deleteGroup(${g.GroupID}, '${g.GroupName.replace(/'/g,"\\'")}')" >Delete</button>
            </div>
          </div>
        `).join('');
      }

      document.getElementById('add-group-btn').addEventListener('click', () => {
        showModal(`
          <h3>Create Group</h3>
          <form id="create-group-form" style="display:flex;flex-direction:column;gap:1rem;">
            <label><span>Group Name</span><input type="text" id="new-group-name" required /></label>
            <div class="form-actions">
              <button type="button" class="ghost btn-sm" onclick="closeModal()">Cancel</button>
              <button type="submit" class="btn-sm btn-approve">Create</button>
            </div>
          </form>
        `);
        document.getElementById('create-group-form').addEventListener('submit', async (e) => {
          e.preventDefault();
          await api('/api/admin/groups', { method: 'POST', body: JSON.stringify({ groupName: document.getElementById('new-group-name').value })});
          closeModal();
          loadGroups();
        });
      });

      async function deleteGroup(id, name) {
        if (!confirm(`Delete group "${name}"? Members will lose inherited roles.`)) return;
        await api(`/api/admin/groups/${id}`, { method: 'DELETE' });
        loadGroups();
        loadUsers();
      }

      async function manageGroupRoles(groupId, groupName) {
        const groups = await api('/api/admin/groups');
        const group = groups.find(g => g.GroupID === groupId);
        const currentRoles = group && group.Roles ? group.Roles.split(', ') : [];

        // Get full role list with IDs
        const groupDetail = await api(`/api/admin/groups`);
        // We need role IDs for this group - fetch via a query
        // For now use allRoles
        showModal(`
          <h3>Manage Roles â€” ${groupName}</h3>
          <div id="group-role-list" class="chip-container" style="margin-bottom:1rem;">
            ${currentRoles.map(r => {
              const role = allRoles.find(ar => ar.RoleName === r);
              return role ? `<div class="chip"><span class="badge badge-role">${r}</span><button onclick="removeGroupRole(${groupId},${role.RoleID},'${groupName}')">Ã—</button></div>` : '';
            }).join('')}
          </div>
          <div style="display:flex;gap:0.4rem;">
            <select class="inline-select" id="add-group-role-select">
              <option value="">Add roleâ€¦</option>
              ${allRoles.filter(r => !currentRoles.includes(r.RoleName)).map(r => `<option value="${r.RoleID}">${r.RoleName}</option>`).join('')}
            </select>
            <button class="btn-sm btn-add" onclick="addGroupRole(${groupId},'${groupName}')">Add</button>
          </div>
          <div class="form-actions" style="margin-top:1.5rem;">
            <button class="ghost btn-sm" onclick="closeModal()">Close</button>
          </div>
        `);
      }

      async function addGroupRole(groupId, groupName) {
        const roleId = document.getElementById('add-group-role-select').value;
        if (!roleId) return;
        await api(`/api/admin/groups/${groupId}/roles/${roleId}`, { method: 'POST' });
        await loadGroups();
        manageGroupRoles(groupId, groupName);
      }

      async function removeGroupRole(groupId, roleId, groupName) {
        await api(`/api/admin/groups/${groupId}/roles/${roleId}`, { method: 'DELETE' });
        await loadGroups();
        manageGroupRoles(groupId, groupName);
      }

      // â”€â”€â”€ PERMISSIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      let allPermissions = [];

      async function loadPermissions() {
        allPermissions = await api('/api/admin/permissions') || [];
        // Populate role selector
        const select = document.getElementById('perm-role-select');
        const currentVal = select.value;
        select.innerHTML = '<option value="">Choose a roleâ€¦</option>' +
          allRoles.map(r => `<option value="${r.RoleID}" ${r.RoleID == currentVal ? 'selected' : ''}>${r.RoleName}</option>`).join('');
      }

      document.getElementById('perm-role-select').addEventListener('change', async (e) => {
        const roleId = e.target.value;
        const panel = document.getElementById('permissions-panel');
        if (!roleId) { panel.innerHTML = ''; return; }
        await renderRolePermissions(roleId);
      });

      async function renderRolePermissions(roleId) {
        const rolePerms = await api(`/api/admin/roles/${roleId}/permissions`);
        const roleName = allRoles.find(r => r.RoleID == roleId)?.RoleName || '';
        const rolePermIds = rolePerms.map(p => p.PermissionID);
        const panel = document.getElementById('permissions-panel');

        // Group permissions by category
        const categories = {};
        allPermissions.forEach(p => {
          const cat = p.PermissionName.split('.')[0];
          if (!categories[cat]) categories[cat] = [];
          categories[cat].push(p);
        });

        panel.innerHTML = Object.entries(categories).map(([cat, perms]) => `
          <div style="margin-bottom:1.2rem;">
            <h4 style="margin:0 0 0.4rem;text-transform:capitalize;color:var(--accent);">${cat}</h4>
            ${perms.map(p => {
              const has = rolePermIds.includes(p.PermissionID);
              return `<label style="display:flex;align-items:center;gap:0.5rem;padding:0.3rem 0;cursor:pointer;font-size:0.9rem;">
                <input type="checkbox" ${has ? 'checked' : ''} onchange="togglePerm(${roleId},${p.PermissionID},this.checked)" style="accent-color:var(--accent-2);width:1.1rem;height:1.1rem;" />
                <span>${p.PermissionName}</span>
                <span style="color:var(--muted);font-size:0.8rem;margin-left:auto;">${p.Description || ''}</span>
              </label>`;
            }).join('')}
          </div>
        `).join('');
      }

      async function togglePerm(roleId, permId, checked) {
        if (checked) {
          await api(`/api/admin/roles/${roleId}/permissions/${permId}`, { method: 'POST' });
        } else {
          await api(`/api/admin/roles/${roleId}/permissions/${permId}`, { method: 'DELETE' });
        }
      }

      async function manageRolePerms(roleId, roleName) {
        // Switch to permissions tab and select the role
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        document.querySelector('[data-tab="permissions"]').classList.add('active');
        document.getElementById('tab-permissions').classList.add('active');
        document.getElementById('perm-role-select').value = roleId;
        await renderRolePermissions(roleId);
      }

      // â”€â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      loadPending();
      loadUsers();
      loadRoles();
      loadGroups();
      loadPermissions();
    </script>
  </body>
</html>

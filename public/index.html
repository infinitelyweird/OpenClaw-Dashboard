<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard ¬∑ Infinitely Weird DevOps</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="nav.css">
  <link rel="stylesheet" href="dashboard.css">
  <link rel="stylesheet" href="loader.css">
  <style>
    :root {
      --bg: #0a0a1a;
      --bg-surface: #12122a;
      --glass: rgba(255,255,255,0.06);
      --glass-hover: rgba(255,255,255,0.12);
      --border: rgba(255,255,255,0.08);
      --text: #f0f0ff;
      --text-muted: rgba(255,255,255,0.5);
      --accent: #a78bfa;
      --accent-2: #06b6d4;
      --accent-glass: rgba(139,92,246,0.2);
      --gradient: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
      --gradient-accent: linear-gradient(135deg, #a78bfa, #06b6d4);
    }
    [data-theme="light"] {
      --bg: #f4f4fb;
      --bg-surface: #ffffff;
      --glass: rgba(0,0,0,0.04);
      --glass-hover: rgba(0,0,0,0.08);
      --border: rgba(0,0,0,0.1);
      --text: #1a1a2e;
      --text-muted: rgba(0,0,0,0.5);
      --accent-glass: rgba(139,92,246,0.1);
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.5;
    }

    /* KPI Cards Grid */
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    .glass-card {
      background: var(--glass);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 1.25rem;
      transition: all 0.25s ease;
    }
    .glass-card:hover {
      background: var(--glass-hover);
      transform: translateY(-2px);
      box-shadow: 0 8px 32px rgba(0,0,0,0.2);
    }
    .kpi-card .kpi-icon { font-size: 1.8rem; margin-bottom: 0.5rem; }
    .kpi-card .kpi-value {
      font-size: 2rem;
      font-weight: 800;
      background: var(--gradient-accent);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .kpi-card .kpi-label {
      font-size: 0.8rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 600;
    }

    /* Widgets grid */
    .widgets-grid {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 1.25rem;
    }
    @media (max-width: 900px) { .widgets-grid { grid-template-columns: 1fr; } }

    .widget-title {
      font-size: 1rem;
      font-weight: 700;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    /* Activity feed */
    .activity-item {
      display: flex;
      align-items: flex-start;
      gap: 0.75rem;
      padding: 0.75rem 0;
      border-bottom: 1px solid var(--border);
    }
    .activity-item:last-child { border-bottom: none; }
    .activity-dot {
      width: 8px; height: 8px;
      border-radius: 50%;
      margin-top: 6px;
      flex-shrink: 0;
    }
    .activity-text { font-size: 0.85rem; }
    .activity-time { font-size: 0.75rem; color: var(--text-muted); }

    /* Quick actions */
    .quick-actions { display: flex; flex-direction: column; gap: 0.5rem; }
    .action-btn {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem 1rem;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--glass);
      color: var(--text);
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 500;
      transition: all 0.2s ease;
    }
    .action-btn:hover {
      background: var(--accent-glass);
      border-color: var(--accent);
    }
    .action-btn .action-icon { font-size: 1.3rem; }

    /* System status */
    .status-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.6rem 0;
      border-bottom: 1px solid var(--border);
      font-size: 0.85rem;
    }
    .status-row:last-child { border-bottom: none; }
    .status-dot {
      width: 10px; height: 10px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 0.5rem;
    }
    .status-green { background: #22c55e; }
    .status-yellow { background: #eab308; }
    .status-red { background: #ef4444; }

    .page-title {
      font-size: 1.5rem;
      font-weight: 800;
      margin-bottom: 1.5rem;
    }
    .page-title span {
      background: var(--gradient-accent);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    /* Skeleton loading */
    .skeleton {
      background: linear-gradient(90deg, var(--glass) 25%, var(--glass-hover) 50%, var(--glass) 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
      border-radius: 8px;
    }
    @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
  </style>
</head>
<body>
  <div id="page-content">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1.5rem">
      <h1 class="page-title" style="margin-bottom:0">Welcome back, <span id="greeting-name">...</span> üëã</h1>
      <button class="dashboard-edit-btn" title="Edit Dashboard">‚úèÔ∏è Edit</button>
    </div>

    <div class="kpi-grid" id="kpi-grid">
      <div class="dashboard-widget glass-card kpi-card" data-widget-id="kpi-tasks"><div class="kpi-icon">üìã</div><div class="kpi-value" id="kpi-tasks">‚Äî</div><div class="kpi-label">Active Tasks</div></div>
      <div class="dashboard-widget glass-card kpi-card" data-widget-id="kpi-projects"><div class="kpi-icon">üìÅ</div><div class="kpi-value" id="kpi-projects">‚Äî</div><div class="kpi-label">Open Projects</div></div>
      <div class="dashboard-widget glass-card kpi-card" data-widget-id="kpi-deployments"><div class="kpi-icon">üöÄ</div><div class="kpi-value" id="kpi-deployments">‚Äî</div><div class="kpi-label">Pending Deploys</div></div>
      <div class="dashboard-widget glass-card kpi-card" data-widget-id="kpi-health"><div class="kpi-icon">üíö</div><div class="kpi-value" id="kpi-health">‚Äî</div><div class="kpi-label">System Health</div></div>
      <div class="dashboard-widget glass-card kpi-card" data-widget-id="kpi-security"><div class="kpi-icon">üõ°Ô∏è</div><div class="kpi-value" id="kpi-security">‚Äî</div><div class="kpi-label">Security Score</div></div>
      <div class="dashboard-widget glass-card kpi-card" data-widget-id="kpi-team"><div class="kpi-icon">üë•</div><div class="kpi-value" id="kpi-team">‚Äî</div><div class="kpi-label">Team Members</div></div>
    </div>

    <div class="widgets-grid">
      <div class="dashboard-widget" data-widget-id="widget-activity">
        <div class="glass-card">
          <div class="widget-title">‚ö° Recent Activity</div>
          <div id="activity-feed">
            <div class="activity-item"><div class="activity-dot status-green"></div><div><div class="activity-text">Loading activity...</div><div class="activity-time">just now</div></div></div>
          </div>
        </div>

        <div class="glass-card" style="margin-top:1.25rem">
          <div class="widget-title">üñ•Ô∏è System Status</div>
          <div id="system-status">
            <div class="status-row"><span><span class="status-dot status-green"></span>API Server</span><span>Checking...</span></div>
            <div class="status-row"><span><span class="status-dot status-green"></span>CPU Usage</span><span id="sys-cpu">‚Äî</span></div>
            <div class="status-row"><span><span class="status-dot status-green"></span>Memory</span><span id="sys-mem">‚Äî</span></div>
            <div class="status-row"><span><span class="status-dot status-green"></span>Uptime</span><span id="sys-uptime">‚Äî</span></div>
          </div>
        </div>
      </div>

      <div class="dashboard-widget" data-widget-id="widget-actions">
        <div class="glass-card">
          <div class="widget-title">‚ö° Quick Actions</div>
          <div class="quick-actions">
            <button class="action-btn" onclick="window.location.href='tasks.html'"><span class="action-icon">‚ûï</span> Create Task</button>
            <button class="action-btn" onclick="window.location.href='projects.html'"><span class="action-icon">üìÅ</span> New Project</button>
            <button class="action-btn" onclick="window.location.href='deployments.html'"><span class="action-icon">üöÄ</span> Start Deployment</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="loader.js"></script>
  <script src="nav.js"></script>
  <script src="dashboard.js"></script>
  <script>
    (function () {
      const token = localStorage.getItem('token');
      if (!token) return;

      // Greeting
      try {
        const payload = JSON.parse(atob(token.split('.')[1].replace(/-/g,'+').replace(/_/g,'/')));
        document.getElementById('greeting-name').textContent = payload.username || 'Operator';
      } catch { document.getElementById('greeting-name').textContent = 'Operator'; }

      // ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ
      function relativeTime(dateStr) {
        const diff = Date.now() - new Date(dateStr).getTime();
        const s = Math.floor(diff / 1000);
        if (s < 60) return 'just now';
        const m = Math.floor(s / 60);
        if (m < 60) return m + ' min ago';
        const h = Math.floor(m / 60);
        if (h < 24) return h + ' hour' + (h > 1 ? 's' : '') + ' ago';
        const d = Math.floor(h / 24);
        return d + ' day' + (d > 1 ? 's' : '') + ' ago';
      }

      function formatUptime(seconds) {
        const d = Math.floor(seconds / 86400);
        const h = Math.floor((seconds % 86400) / 3600);
        const m = Math.floor((seconds % 3600) / 60);
        const parts = [];
        if (d > 0) parts.push(d + 'd');
        if (h > 0) parts.push(h + 'h');
        parts.push(m + 'm');
        return parts.join(' ');
      }

      function setKPI(id, value) {
        const el = document.getElementById(id);
        if (el) el.textContent = value;
      }

      function dotColor(statusEl, color) {
        const dot = statusEl.querySelector('.status-dot');
        if (dot) { dot.className = 'status-dot status-' + color; }
      }

      // ‚îÄ‚îÄ Fetch All KPIs ‚îÄ‚îÄ
      async function fetchKPIs() {
        // Active Tasks
        try {
          const res = await apiFetch('/api/tasks');
          if (res && res.ok) {
            const data = await res.json();
            const tasks = Array.isArray(data) ? data : (data.tasks || []);
            const active = tasks.filter(t => t.Status !== 'Completed' && t.Status !== 'Cancelled').length;
            setKPI('kpi-tasks', active);
          }
        } catch { setKPI('kpi-tasks', '‚Äî'); }

        // Open Projects
        try {
          const res = await apiFetch('/api/projects');
          if (res && res.ok) {
            const data = await res.json();
            const projects = Array.isArray(data) ? data : (data.projects || []);
            const open = projects.filter(p => p.Status === 'Active' || p.Status === 'Planning').length;
            setKPI('kpi-projects', open);
          }
        } catch { setKPI('kpi-projects', '‚Äî'); }

        // Pending Deploys ‚Äî no backend yet
        setKPI('kpi-deployments', '0');

        // System Health ‚Äî derive from CPU/memory
        try {
          const [cpuRes, memRes] = await Promise.all([
            apiFetch('/api/widgets/system/cpu'),
            apiFetch('/api/widgets/system/memory')
          ]);
          let cpuLoad = 0, memPct = 0;
          if (cpuRes && cpuRes.ok) { const d = await cpuRes.json(); cpuLoad = d.currentLoad || 0; }
          if (memRes && memRes.ok) { const d = await memRes.json(); memPct = d.usedPercent || 0; }
          const health = Math.round(100 - (cpuLoad + memPct) / 2);
          setKPI('kpi-health', health + '%');
        } catch { setKPI('kpi-health', '‚Äî'); }

        // Security Score ‚Äî based on open ports count
        try {
          const res = await apiFetch('/api/security/open-ports');
          if (res && res.ok) {
            const ports = await res.json();
            const count = Array.isArray(ports) ? ports.length : 0;
            // Fewer open ports = higher score. 100 if ‚â§5, subtract 2 per extra port, min 50
            const score = Math.max(50, 100 - Math.max(0, count - 5) * 2);
            setKPI('kpi-security', score + '%');
          }
        } catch { setKPI('kpi-security', '‚Äî'); }

        // Team Members
        try {
          const res = await apiFetch('/api/widgets/users/stats');
          if (res && res.ok) {
            const d = await res.json();
            setKPI('kpi-team', d.totalUsers || '‚Äî');
          }
        } catch { setKPI('kpi-team', '‚Äî'); }
      }

      // ‚îÄ‚îÄ Recent Activity (audit logs or fallback to recent tasks) ‚îÄ‚îÄ
      async function fetchActivity() {
        const feed = document.getElementById('activity-feed');
        // Try audit logs first
        try {
          const res = await apiFetch('/api/admin/audit-logs?limit=10');
          if (res && res.ok) {
            const data = await res.json();
            const logs = Array.isArray(data) ? data : (data.logs || data.auditLogs || []);
            if (logs.length) {
              feed.innerHTML = logs.map(log => {
                const user = log.Username || log.username || 'System';
                const action = log.Action || log.action || log.event || 'action';
                const detail = log.Details || log.details || '';
                const time = log.CreatedAt || log.createdAt || log.timestamp;
                const color = action.toLowerCase().includes('delete') ? '#ef4444' :
                              action.toLowerCase().includes('create') ? '#22c55e' : '#a78bfa';
                return `<div class="activity-item">
                  <div class="activity-dot" style="background:${color}"></div>
                  <div><div class="activity-text"><strong>${user}</strong> ${action} ${detail}</div>
                  <div class="activity-time">${time ? relativeTime(time) : ''}</div></div>
                </div>`;
              }).join('');
              return;
            }
          }
        } catch {}

        // Fallback: recent tasks
        try {
          const res = await apiFetch('/api/tasks');
          if (res && res.ok) {
            const tasks = (await res.json()).slice(0, 8);
            if (tasks.length) {
              feed.innerHTML = tasks.map(t => {
                const statusColor = t.Status === 'Completed' ? '#22c55e' :
                                    t.Status === 'In Progress' ? '#eab308' : '#a78bfa';
                return `<div class="activity-item">
                  <div class="activity-dot" style="background:${statusColor}"></div>
                  <div><div class="activity-text">${t.Title || 'Task'} ‚Äî <em>${t.Status || 'Open'}</em></div>
                  <div class="activity-time">${t.CreatedAt ? relativeTime(t.CreatedAt) : ''}</div></div>
                </div>`;
              }).join('');
              return;
            }
          }
        } catch {}

        feed.innerHTML = '<div class="activity-item"><div class="activity-dot status-yellow"></div><div><div class="activity-text">No recent activity</div></div></div>';
      }

      // ‚îÄ‚îÄ System Status ‚îÄ‚îÄ
      async function fetchSystemStatus() {
        const rows = document.querySelectorAll('#system-status .status-row');

        // API Server
        try {
          const res = await apiFetch('/api/version');
          if (res && res.ok) {
            rows[0].querySelector('span:last-child').textContent = 'Online';
            dotColor(rows[0], 'green');
          } else throw new Error();
        } catch {
          rows[0].querySelector('span:last-child').textContent = 'Offline';
          dotColor(rows[0], 'red');
        }

        // CPU, Memory, Uptime
        try {
          const res = await apiFetch('/api/widgets/system/cpu');
          if (res && res.ok) {
            const d = await res.json();
            setKPI('sys-cpu', d.currentLoad + '%');
            const pct = d.currentLoad;
            dotColor(rows[1], pct > 90 ? 'red' : pct > 70 ? 'yellow' : 'green');
          }
        } catch { setKPI('sys-cpu', '‚Äî'); }

        try {
          const res = await apiFetch('/api/widgets/system/memory');
          if (res && res.ok) {
            const d = await res.json();
            setKPI('sys-mem', d.usedPercent + '%');
            dotColor(rows[2], d.usedPercent > 90 ? 'red' : d.usedPercent > 70 ? 'yellow' : 'green');
          }
        } catch { setKPI('sys-mem', '‚Äî'); }

        try {
          const res = await apiFetch('/api/widgets/system/os');
          if (res && res.ok) {
            const d = await res.json();
            setKPI('sys-uptime', d.uptimeFormatted || formatUptime(d.uptime || 0));
          }
        } catch { setKPI('sys-uptime', '‚Äî'); }
      }

      // ‚îÄ‚îÄ Init ‚îÄ‚îÄ
      async function init() {
        AppLoader.show();
        await Promise.all([fetchKPIs(), fetchActivity(), fetchSystemStatus()]);
        AppLoader.hide();
      }

      init();

      // Auto-refresh system status every 10s
      setInterval(fetchSystemStatus, 10000);
      // Refresh KPIs every 60s
      setInterval(fetchKPIs, 60000);
      // Refresh activity every 30s
      setInterval(fetchActivity, 30000);
    })();
  </script>
</body>
</html>

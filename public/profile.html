<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Profile - Infinitely Weird DevOps</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Space+Grotesk:wght@500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="styles.css" />
  <link rel="stylesheet" href="nav.css" />
  <link rel="stylesheet" href="loader.css" />
  <link rel="stylesheet" href="tooltips.css" />
  <style>
    /* Profile-specific styles using design system variables */
    .profile-page { max-width: 800px; margin: 0 auto; }

    .glass-card {
      background: var(--bg-glass);
      border: 1px solid var(--border-glass);
      border-radius: var(--radius-lg);
      backdrop-filter: blur(var(--blur, 20px));
      -webkit-backdrop-filter: blur(var(--blur, 20px));
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      box-shadow: var(--shadow-sm);
    }

    .section-title {
      font-family: 'Space Grotesk', sans-serif;
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--text-primary);
      margin: 0 0 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    /* Identity card */
    .identity-card { display: flex; align-items: center; gap: 1.5rem; flex-wrap: wrap; }
    .avatar-wrapper {
      position: relative; width: 120px; height: 120px; border-radius: 50%;
      overflow: hidden; cursor: pointer; border: 3px solid var(--border-glass);
      transition: border-color var(--duration) var(--ease); flex-shrink: 0;
    }
    .avatar-wrapper:hover { border-color: var(--color-accent); }
    .avatar-wrapper img { width: 100%; height: 100%; object-fit: cover; }
    .avatar-placeholder {
      width: 100%; height: 100%;
      background: linear-gradient(135deg, rgba(167,139,250,0.25), rgba(96,165,250,0.25));
      display: flex; align-items: center; justify-content: center;
      font-size: 2.5rem; font-weight: 700; color: var(--color-accent);
    }
    .avatar-overlay {
      position: absolute; inset: 0; background: rgba(0,0,0,0.55);
      display: flex; align-items: center; justify-content: center;
      opacity: 0; transition: opacity var(--duration) var(--ease);
      font-size: 0.8rem; font-weight: 600; color: #fff;
    }
    .avatar-wrapper:hover .avatar-overlay { opacity: 1; }

    .identity-info { flex: 1; min-width: 200px; }
    .identity-name {
      font-family: 'Space Grotesk', sans-serif;
      font-size: 1.6rem; font-weight: 700; color: var(--text-primary); margin: 0;
      display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap;
    }
    .identity-username { font-size: 0.9rem; color: var(--text-muted); margin: 0.15rem 0 0; }
    .identity-email { font-size: 0.85rem; color: var(--text-secondary); margin: 0.25rem 0 0; }
    .identity-member-since { font-size: 0.75rem; color: var(--text-muted); margin-top: 0.5rem; }

    .role-pill {
      display: inline-block; padding: 0.2rem 0.65rem; border-radius: 999px;
      background: rgba(167,139,250,0.15); color: var(--color-accent);
      font-size: 0.75rem; font-weight: 600;
    }

    .group-tag {
      display: inline-block; padding: 0.2rem 0.65rem; border-radius: 999px;
      background: rgba(52,211,153,0.15); color: var(--color-success);
      font-size: 0.75rem; font-weight: 600;
    }

    /* About */
    .bio-textarea {
      width: 100%; min-height: 80px; resize: vertical;
      background: var(--bg-glass-input); border: 1px solid var(--border-input);
      color: var(--text-primary); padding: 0.65rem 0.8rem; border-radius: var(--radius-sm);
      font-family: 'Inter', sans-serif; font-size: 0.85rem; outline: none;
      transition: border-color var(--duration) var(--ease);
    }
    .bio-textarea:focus { border-color: var(--border-input-focus); }
    .char-counter { text-align: right; font-size: 0.72rem; color: var(--text-muted); margin-top: 0.25rem; }
    .char-counter.warn { color: var(--color-warning); }
    .char-counter.over { color: var(--color-danger); }

    /* Contact & Work grid */
    .field-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
    @media (max-width: 600px) { .field-grid { grid-template-columns: 1fr; } }
    .field-item label {
      display: flex; align-items: center; gap: 0.35rem;
      font-size: 0.78rem; color: var(--text-muted); margin-bottom: 0.3rem; font-weight: 500;
    }
    .field-item input {
      width: 100%; background: var(--bg-glass-input); border: 1px solid var(--border-input);
      color: var(--text-primary); padding: 0.55rem 0.8rem; border-radius: var(--radius-sm);
      font-family: inherit; font-size: 0.85rem; outline: none;
      transition: border-color var(--duration) var(--ease);
    }
    .field-item input:focus { border-color: var(--border-input-focus); }
    .field-item input[readonly] { opacity: 0.6; cursor: not-allowed; }

    /* Roles & Groups */
    .rg-columns { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; }
    @media (max-width: 600px) { .rg-columns { grid-template-columns: 1fr; } }
    .rg-col h4 { font-size: 0.85rem; font-weight: 600; color: var(--text-secondary); margin: 0 0 0.6rem; }
    .rg-list { display: flex; flex-wrap: wrap; gap: 0.4rem; }
    .rg-empty { font-size: 0.8rem; color: var(--text-muted); font-style: italic; }
    .rg-note { font-size: 0.72rem; color: var(--text-muted); margin-top: 1rem; padding-top: 0.75rem; border-top: 1px solid var(--border-glass); }

    /* Security */
    .form-group { margin-bottom: 1rem; }
    .form-group label {
      display: block; font-size: 0.8rem; color: var(--text-muted);
      margin-bottom: 0.3rem; font-weight: 500;
    }
    .form-group input {
      width: 100%; background: var(--bg-glass-input); border: 1px solid var(--border-input);
      color: var(--text-primary); padding: 0.55rem 0.8rem; border-radius: var(--radius-sm);
      font-family: inherit; font-size: 0.85rem; outline: none;
      transition: border-color var(--duration) var(--ease);
    }
    .form-group input:focus { border-color: var(--border-input-focus); }

    .pw-requirements { display: none; padding: 0.4rem 0 0; font-size: 0.75rem; line-height: 1.6; }
    .pw-requirements.visible { display: block; }
    .pw-req { color: var(--text-muted); transition: color var(--duration); }
    .pw-req.met { color: var(--color-success); }
    .pw-match-error { font-size: 0.75rem; color: var(--color-danger); margin-top: 0.25rem; display: none; }

    /* Buttons */
    .btn {
      padding: 0.5rem 1.2rem; border-radius: var(--radius-sm); border: none;
      font-family: inherit; font-size: 0.85rem; font-weight: 600; cursor: pointer;
      transition: all var(--duration) var(--ease); display: inline-flex;
      align-items: center; gap: 0.4rem;
    }
    .btn-primary { background: var(--color-accent); color: var(--text-inverse); }
    .btn-primary:hover { filter: brightness(1.15); }
    .form-actions { display: flex; gap: 0.6rem; justify-content: flex-end; margin-top: 1rem; }

    /* Messages */
    .msg {
      padding: 0.6rem 1rem; border-radius: var(--radius-sm); font-size: 0.82rem;
      margin-bottom: 1rem; display: none;
    }
    .msg.success { display: block; background: var(--color-success-bg); color: var(--color-success); border: 1px solid rgba(52,211,153,0.3); }
    .msg.error { display: block; background: var(--color-danger-bg); color: var(--color-danger); border: 1px solid rgba(248,113,113,0.3); }

    /* Theme */
    .theme-option {
      width: 60px; height: 40px; border-radius: var(--radius-sm); cursor: pointer;
      border: 2px solid transparent; transition: all var(--duration) var(--ease); position: relative;
    }
    .theme-option.selected { border-color: var(--color-accent); box-shadow: 0 0 12px rgba(167,139,250,0.3); }
    .theme-option:hover { transform: scale(1.05); }
    .theme-check {
      position: absolute; top: -6px; right: -6px; width: 18px; height: 18px;
      background: var(--color-accent); border-radius: 50%; display: none;
      align-items: center; justify-content: center; font-size: 0.7rem;
      color: var(--text-inverse); font-weight: 700;
    }
    .theme-option.selected .theme-check { display: flex; }
    .theme-label {
      position: absolute; bottom: -18px; left: 50%; transform: translateX(-50%);
      font-size: 0.65rem; color: var(--text-muted); white-space: nowrap; font-weight: 500;
    }
    .theme-options { display: flex; gap: 0.8rem; flex-wrap: wrap; padding-bottom: 1.2rem; }

    .page-header h1 {
      font-family: 'Space Grotesk', sans-serif; font-size: 2rem; margin: 0; color: var(--text-primary);
    }
    .page-header h1 span { color: var(--color-accent); }
    .eyebrow {
      font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.15em;
      color: var(--text-muted); margin-bottom: 0.2rem;
    }
  </style>
</head>
<body>
  <script src="nav.js"></script>
  <div id="page-content">
    <div class="profile-page">
      <div class="page-header" style="margin-bottom:1.5rem">
        <p class="eyebrow">Your Identity</p>
        <h1>üë§ <span>My</span> Profile</h1>
      </div>

      <div id="forcePasswordBanner" style="display:none;background:rgba(251,191,36,0.15);border:1px solid rgba(251,191,36,0.4);color:#fbbf24;padding:1rem 1.25rem;border-radius:var(--radius-lg);margin-bottom:1.5rem;font-size:0.9rem;font-weight:600">‚ö†Ô∏è Your password was reset by an administrator. Please set a new password below.</div>
      <div id="profileMsg" class="msg"></div>

      <!-- 1. Avatar + Identity Card -->
      <div class="glass-card">
        <div class="identity-card">
          <div class="avatar-wrapper" onclick="document.getElementById('avatarInput').click()">
            <div id="avatarDisplay"></div>
            <div class="avatar-overlay">üì∑ Change</div>
          </div>
          <input type="file" id="avatarInput" accept="image/*" style="display:none" />
          <div class="identity-info">
            <h2 class="identity-name">
              <span id="identityName">‚Äî</span>
              <span id="identityRoles"></span>
            </h2>
            <p class="identity-username" id="identityUsername">@‚Äî</p>
            <p class="identity-email" id="identityEmail">‚Äî</p>
            <p class="identity-member-since" id="identityMemberSince"></p>
          </div>
        </div>
      </div>

      <!-- 2. About -->
      <div class="glass-card">
        <h3 class="section-title">üìù About</h3>
        <textarea class="bio-textarea" id="bioInput" maxlength="500" placeholder="Tell us about yourself..."></textarea>
        <div class="char-counter" id="bioCounter">0 / 500</div>
        <div class="form-actions">
          <button class="btn btn-primary" onclick="saveBio()">üíæ Save Bio</button>
        </div>
      </div>

      <!-- 3. Contact & Work -->
      <div class="glass-card">
        <h3 class="section-title">üìá Contact &amp; Work</h3>
        <div class="field-grid">
          <div class="field-item">
            <label>‚úâÔ∏è Email</label>
            <input type="email" id="fieldEmail" readonly />
          </div>
          <div class="field-item">
            <label>üì± Phone</label>
            <input type="tel" id="fieldPhone" placeholder="Your phone number" />
          </div>
          <div class="field-item">
            <label>üìç Location</label>
            <input type="text" id="fieldLocation" placeholder="City, Country" />
          </div>
          <div class="field-item">
            <label>üíº Job Title</label>
            <input type="text" id="fieldJobTitle" placeholder="Your role" />
          </div>
          <div class="field-item">
            <label>üè¢ Department</label>
            <input type="text" id="fieldDepartment" placeholder="Your department" />
          </div>
        </div>
        <div class="form-actions">
          <button class="btn btn-primary" onclick="saveContactWork()">üíæ Save Details</button>
        </div>
      </div>

      <!-- 4. Roles & Groups -->
      <div class="glass-card">
        <h3 class="section-title">üõ°Ô∏è Roles &amp; Groups</h3>
        <div class="rg-columns">
          <div class="rg-col">
            <h4>Roles</h4>
            <div class="rg-list" id="rolesList">
              <span class="rg-empty">No roles assigned</span>
            </div>
          </div>
          <div class="rg-col">
            <h4>Groups</h4>
            <div class="rg-list" id="groupsList">
              <span class="rg-empty">No groups assigned</span>
            </div>
          </div>
        </div>
        <p class="rg-note">Roles and groups are managed by administrators.</p>
      </div>

      <!-- 5. Security -->
      <div class="glass-card" id="password">
        <h3 class="section-title">üîí Security</h3>
        <div class="form-group">
          <label>Current Password</label>
          <input type="password" id="currentPw" />
        </div>
        <div class="form-group">
          <label>New Password</label>
          <input type="password" id="newPw" placeholder="Min 8 characters" />
          <div class="pw-requirements" id="pw-requirements">
            <div class="pw-req" id="req-length">‚úó At least 8 characters</div>
            <div class="pw-req" id="req-upper">‚úó Contains uppercase letter</div>
            <div class="pw-req" id="req-lower">‚úó Contains lowercase letter</div>
            <div class="pw-req" id="req-number">‚úó Contains a number</div>
          </div>
        </div>
        <div class="form-group">
          <label>Confirm New Password</label>
          <input type="password" id="confirmPw" />
          <div class="pw-match-error" id="pw-match-error">Passwords don't match</div>
        </div>
        <div class="form-actions">
          <button class="btn btn-primary" onclick="changePassword()">üîë Update Password</button>
        </div>
      </div>

      <!-- 6. Preferences -->
      <div class="glass-card">
        <h3 class="section-title">üé® Preferences</h3>
        <p style="font-size:.82rem;color:var(--text-muted);margin-bottom:.8rem">Choose your vibe. Because DevOps should look good. üíÖ</p>
        <div class="theme-options">
          <div class="theme-option selected" data-theme="dark-purple" style="background:linear-gradient(135deg,#0f172a,#1e1b4b)" onclick="selectTheme(this)"><div class="theme-check">‚úì</div><div class="theme-label">Purple Haze</div></div>
          <div class="theme-option" data-theme="dark-teal" style="background:linear-gradient(135deg,#0a1a1f,#134e4a)" onclick="selectTheme(this)"><div class="theme-check">‚úì</div><div class="theme-label">Ocean Deep</div></div>
          <div class="theme-option" data-theme="dark-rose" style="background:linear-gradient(135deg,#1a0a1e,#4a1942)" onclick="selectTheme(this)"><div class="theme-check">‚úì</div><div class="theme-label">Neon Rose</div></div>
          <div class="theme-option" data-theme="midnight" style="background:linear-gradient(135deg,#050508,#1a1a2e)" onclick="selectTheme(this)"><div class="theme-check">‚úì</div><div class="theme-label">Midnight</div></div>
          <div class="theme-option" data-theme="light" style="background:linear-gradient(135deg,#f0f4f8,#ffffff)" onclick="selectTheme(this)"><div class="theme-check">‚úì</div><div class="theme-label">Clean Light</div></div>
        </div>
      </div>
    </div>
  </div>

  <script src="loader.js"></script>
  <script src="tooltips.js"></script>
  <script>
    // Safety: ensure loader hides even if something goes wrong
    window.addEventListener('load', () => { setTimeout(() => { if (typeof AppLoader !== 'undefined') AppLoader.hide(); }, 5000); });
    // Role & Group descriptions for tooltips
    const roleDescriptions = {
      'Administrator': 'Full system access. Can manage users, roles, groups, and all settings.',
      'User': 'Standard access. Can view dashboards, manage own tasks and profile.',
      'Manager': 'Team management. Can assign tasks, view reports, and manage projects.',
      'Viewer': 'Read-only access. Can view dashboards and reports but cannot modify data.',
    };
    const groupDescriptions = {
      'Administrators': 'System administrators group. Members inherit all admin permissions.',
      'Standard User': 'Default group for approved users. Provides basic system access.',
    };

    const TOKEN = localStorage.getItem('token');
    const H = () => ({ 'Authorization': `Bearer ${TOKEN}`, 'Content-Type': 'application/json' });
    let profileData = {};

    function showMsg(text, type) {
      const el = document.getElementById('profileMsg');
      el.textContent = text;
      el.className = 'msg ' + type;
      setTimeout(() => el.className = 'msg', 4000);
    }

    async function loadProfile() {
      if (typeof AppLoader !== 'undefined') AppLoader.show();
      try {
        const r = await fetch('/api/profile', { headers: H() });
        const p = await r.json();
        profileData = p;

        // Avatar
        const display = document.getElementById('avatarDisplay');
        if (p.AvatarPath) {
          display.innerHTML = `<img src="${p.AvatarPath}" alt="Avatar" />`;
        } else {
          const initials = (p.DisplayName || p.Username || '?').substring(0, 2).toUpperCase();
          display.innerHTML = `<div class="avatar-placeholder">${initials}</div>`;
        }

        // Identity
        document.getElementById('identityName').textContent = p.DisplayName || p.Username || '‚Äî';
        document.getElementById('identityUsername').textContent = '@' + (p.Username || '‚Äî');
        document.getElementById('identityEmail').textContent = p.Email || '';
        if (p.CreatedAt) {
          const d = new Date(p.CreatedAt);
          document.getElementById('identityMemberSince').textContent = 'üìÖ Member since ' + d.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
        }

        // Role pills in identity header
        const rolesSpan = document.getElementById('identityRoles');
        rolesSpan.innerHTML = (p.roles || []).map(r => `<span class="role-pill" data-tooltip="${roleDescriptions[r] || 'Role assigned to your account.'}" data-tooltip-title="${r}">${r}</span>`).join(' ');

        // Bio
        document.getElementById('bioInput').value = p.Bio || '';
        updateBioCounter();

        // Contact & Work fields
        document.getElementById('fieldEmail').value = p.Email || '';
        document.getElementById('fieldPhone').value = p.Phone || '';
        document.getElementById('fieldLocation').value = p.Location || '';
        document.getElementById('fieldJobTitle').value = p.JobTitle || '';
        document.getElementById('fieldDepartment').value = p.Department || '';

        // Roles & Groups lists
        const rolesList = document.getElementById('rolesList');
        if (p.roles && p.roles.length) {
          rolesList.innerHTML = p.roles.map(r => `<span class="role-pill" data-tooltip="${roleDescriptions[r] || 'Role assigned to your account.'}" data-tooltip-title="${r}">${r}</span>`).join('');
        } else {
          rolesList.innerHTML = '<span class="rg-empty">No roles assigned</span>';
        }
        const groupsList = document.getElementById('groupsList');
        if (p.groups && p.groups.length) {
          groupsList.innerHTML = p.groups.map(g => `<span class="group-tag" data-tooltip="${groupDescriptions[g] || 'Group membership assigned by an administrator.'}" data-tooltip-title="${g}">${g}</span>`).join('');
        } else {
          groupsList.innerHTML = '<span class="rg-empty">No groups assigned</span>';
        }

        // Theme
        const savedTheme = localStorage.getItem('theme') || 'dark-purple';
        document.querySelectorAll('.theme-option').forEach(t => t.classList.toggle('selected', t.dataset.theme === savedTheme));
      } catch(e) { console.error(e); } finally { if (typeof AppLoader !== 'undefined') AppLoader.hide(); }
    }

    // Bio
    function updateBioCounter() {
      const textarea = document.getElementById('bioInput');
      const counter = document.getElementById('bioCounter');
      const len = textarea.value.length;
      counter.textContent = len + ' / 500';
      counter.className = 'char-counter' + (len >= 500 ? ' over' : len >= 450 ? ' warn' : '');
    }
    document.getElementById('bioInput').addEventListener('input', updateBioCounter);

    async function saveBio() {
      try {
        const body = {
          displayName: profileData.DisplayName || '',
          bio: document.getElementById('bioInput').value,
          phone: profileData.Phone || '',
          location: profileData.Location || '',
          jobTitle: profileData.JobTitle || '',
          department: profileData.Department || ''
        };
        const r = await fetch('/api/profile', { method: 'PUT', headers: H(), body: JSON.stringify(body) });
        const data = await r.json();
        showMsg(data.message || 'Bio updated! ‚ú®', r.ok ? 'success' : 'error');
        if (r.ok) profileData.Bio = body.bio;
      } catch(e) { showMsg('Failed to save bio', 'error'); }
    }

    async function saveContactWork() {
      try {
        const body = {
          displayName: profileData.DisplayName || '',
          bio: profileData.Bio || '',
          phone: document.getElementById('fieldPhone').value,
          location: document.getElementById('fieldLocation').value,
          jobTitle: document.getElementById('fieldJobTitle').value,
          department: document.getElementById('fieldDepartment').value
        };
        const r = await fetch('/api/profile', { method: 'PUT', headers: H(), body: JSON.stringify(body) });
        const data = await r.json();
        showMsg(data.message || 'Details updated! ‚ú®', r.ok ? 'success' : 'error');
        if (r.ok) Object.assign(profileData, { Phone: body.phone, Location: body.location, JobTitle: body.jobTitle, Department: body.department });
      } catch(e) { showMsg('Failed to save details', 'error'); }
    }

    // Password requirements
    const newPwInput = document.getElementById('newPw');
    const confirmPwInput = document.getElementById('confirmPw');
    const preqsDiv = document.getElementById('pw-requirements');
    const preqs = {
      length: { el: document.getElementById('req-length'), test: v => v.length >= 8 },
      upper:  { el: document.getElementById('req-upper'),  test: v => /[A-Z]/.test(v) },
      lower:  { el: document.getElementById('req-lower'),  test: v => /[a-z]/.test(v) },
      number: { el: document.getElementById('req-number'), test: v => /[0-9]/.test(v) },
    };
    function checkPwReqs() {
      const v = newPwInput.value;
      let allMet = true;
      for (const k in preqs) {
        const met = preqs[k].test(v);
        preqs[k].el.classList.toggle('met', met);
        preqs[k].el.textContent = (met ? '‚úì ' : '‚úó ') + preqs[k].el.textContent.slice(2);
        if (!met) allMet = false;
      }
      return allMet;
    }
    newPwInput.addEventListener('focus', () => preqsDiv.classList.add('visible'));
    newPwInput.addEventListener('input', checkPwReqs);
    confirmPwInput.addEventListener('input', function() {
      document.getElementById('pw-match-error').style.display =
        (this.value.length > 0 && this.value !== newPwInput.value) ? 'block' : 'none';
    });

    async function changePassword() {
      const current = document.getElementById('currentPw').value;
      const newPw = newPwInput.value;
      const confirm = confirmPwInput.value;
      if (!checkPwReqs()) return showMsg('Password does not meet all requirements', 'error');
      if (newPw !== confirm) return showMsg("Passwords don't match! ü§î", 'error');
      try {
        const r = await fetch('/api/profile/change-password', { method: 'POST', headers: H(), body: JSON.stringify({ currentPassword: current, newPassword: newPw }) });
        const data = await r.json();
        showMsg(data.message || 'Password updated!', r.ok ? 'success' : 'error');
        if (r.ok) { document.getElementById('currentPw').value = ''; newPwInput.value = ''; confirmPwInput.value = ''; localStorage.removeItem('forcePasswordChange'); document.getElementById('forcePasswordBanner').style.display = 'none'; }
      } catch(e) { showMsg('Failed to change password', 'error'); }
    }

    // Avatar upload
    document.getElementById('avatarInput').addEventListener('change', async function() {
      const file = this.files[0];
      if (!file) return;
      const formData = new FormData();
      formData.append('avatar', file);
      try {
        const r = await fetch('/api/profile/avatar', {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${TOKEN}` },
          body: formData
        });
        const data = await r.json();
        if (r.ok) { showMsg('Avatar updated! Looking good! üòé', 'success'); loadProfile(); }
        else showMsg(data.message || 'Upload failed', 'error');
      } catch(e) { showMsg('Failed to upload avatar', 'error'); }
    });

    function selectTheme(el) {
      document.querySelectorAll('.theme-option').forEach(t => t.classList.remove('selected'));
      el.classList.add('selected');
      const theme = el.dataset.theme;
      localStorage.setItem('theme', theme);
      if (theme !== 'light') localStorage.setItem('preferred-dark-theme', theme);
      document.documentElement.setAttribute('data-theme', theme);
      // Update nav toggle button
      const btn = document.getElementById('theme-toggle');
      if (btn) btn.textContent = theme === 'light' ? '‚òÄÔ∏è' : 'üåô';
      showMsg('Theme applied! üé®', 'success');
    }

    if (localStorage.getItem('forcePasswordChange') === 'true') {
      document.getElementById('forcePasswordBanner').style.display = 'block';
      setTimeout(() => document.getElementById('password').scrollIntoView({ behavior: 'smooth' }), 500);
    } else if (window.location.hash === '#password') {
      setTimeout(() => document.getElementById('password').scrollIntoView({ behavior: 'smooth' }), 500);
    }

    loadProfile();
  </script>
</body>
</html>
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Profile - Infinitely Weird DevOps</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Space+Grotesk:wght@500;600&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="styles.css" />
  <link rel="stylesheet" href="nav.css" />
  <style>
    :root{--glass:rgba(255,255,255,0.06);--glass-hover:rgba(255,255,255,0.1);--border:rgba(255,255,255,0.12);--text:#f0f0f0;--muted:rgba(255,255,255,0.5);--accent:#34d399;--accent-2:rgba(52,211,153,0.15);--danger:#f87171;--warning:#fbbf24;--info:#60a5fa;--purple:#a78bfa}
    *{box-sizing:border-box}body{font-family:'Inter',sans-serif;margin:0;padding:0;min-height:100vh;background:linear-gradient(135deg,#0f172a 0%,#1e1b4b 50%,#0f172a 100%);color:var(--text)}.gradient-bg{position:fixed;inset:0;z-index:-1;background:linear-gradient(135deg,#0f172a 0%,#1e1b4b 50%,#0f172a 100%)}
    main{max-width:700px;margin:0 auto;padding:1rem 1.5rem 3rem}
    .page-header h1{font-family:'Space Grotesk',sans-serif;font-size:2rem;margin:0}.page-header h1 span{color:var(--accent)}.eyebrow{font-size:.75rem;text-transform:uppercase;letter-spacing:.15em;color:var(--muted);margin-bottom:.2rem}
    .btn{padding:.5rem 1.2rem;border-radius:10px;border:none;font-family:inherit;font-size:.85rem;font-weight:600;cursor:pointer;transition:all .2s;display:inline-flex;align-items:center;gap:.4rem}.btn-primary{background:var(--accent);color:#0f172a}.btn-primary:hover{background:#6ee7b7}.btn-ghost{background:var(--glass);color:var(--text);border:1px solid var(--border)}.btn-ghost:hover{background:var(--glass-hover)}
    .glass-card{background:var(--glass);border:1px solid var(--border);border-radius:16px;backdrop-filter:blur(14px);padding:1.5rem;margin-bottom:1.5rem}
    .section-title{font-family:'Space Grotesk',sans-serif;font-size:1.1rem;margin:0 0 1rem;display:flex;align-items:center;gap:.5rem}

    /* Avatar */
    .avatar-section{display:flex;flex-direction:column;align-items:center;margin-bottom:1rem}
    .avatar-wrapper{position:relative;width:120px;height:120px;border-radius:50%;overflow:hidden;cursor:pointer;border:3px solid var(--border);transition:border-color .2s}
    .avatar-wrapper:hover{border-color:var(--accent)}
    .avatar-wrapper img{width:100%;height:100%;object-fit:cover}
    .avatar-placeholder{width:100%;height:100%;background:linear-gradient(135deg,rgba(52,211,153,.2),rgba(167,139,250,.2));display:flex;align-items:center;justify-content:center;font-size:2.5rem;font-weight:700;color:var(--accent)}
    .avatar-overlay{position:absolute;inset:0;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;opacity:0;transition:opacity .2s;font-size:.8rem;font-weight:600}
    .avatar-wrapper:hover .avatar-overlay{opacity:1}
    .avatar-hint{font-size:.78rem;color:var(--muted);margin-top:.5rem}
    .pw-requirements{display:none;padding:.4rem 0 0;font-size:.75rem;line-height:1.6}
    .pw-requirements.visible{display:block}
    .pw-req{color:var(--muted);transition:color .2s}
    .pw-req.met{color:var(--accent)}
    .pw-match-error{font-size:.75rem;color:var(--danger);margin-top:.25rem;display:none}

    /* Form */
    .form-group{margin-bottom:1rem}
    .form-group label{display:block;font-size:.8rem;color:var(--muted);margin-bottom:.3rem}
    .form-group input,.form-group select{width:100%;background:rgba(255,255,255,.06);border:1px solid var(--border);color:var(--text);padding:.55rem .8rem;border-radius:8px;font-family:inherit;font-size:.85rem;outline:none;transition:border-color .2s}
    .form-group input:focus,.form-group select:focus{border-color:var(--accent)}
    .form-group select option{background:#1e1b4b}
    .form-actions{display:flex;gap:.6rem;justify-content:flex-end;margin-top:1rem}
    .msg{padding:.6rem 1rem;border-radius:8px;font-size:.82rem;margin-bottom:1rem;display:none}.msg.success{display:block;background:rgba(52,211,153,.15);color:#6ee7b7;border:1px solid rgba(52,211,153,.3)}.msg.error{display:block;background:rgba(248,113,113,.15);color:#fca5a5;border:1px solid rgba(248,113,113,.3)}

    /* Theme */
    .theme-options{display:flex;gap:.8rem;flex-wrap:wrap}
    .theme-option{width:60px;height:40px;border-radius:10px;cursor:pointer;border:2px solid transparent;transition:all .2s;position:relative}
    .theme-option.selected{border-color:var(--accent);box-shadow:0 0 12px rgba(52,211,153,.3)}
    .theme-option:hover{transform:scale(1.05)}
    .theme-check{position:absolute;top:-6px;right:-6px;width:18px;height:18px;background:var(--accent);border-radius:50%;display:none;align-items:center;justify-content:center;font-size:.7rem;color:#0f172a;font-weight:700}
    .theme-option.selected .theme-check{display:flex}
  </style>
</head>
<body>
  <div class="gradient-bg"></div>
  <script src="nav.js"></script>
  <main>
    <div class="page-header" style="margin-bottom:1.5rem">
      <p class="eyebrow">Your Identity</p>
      <h1>ðŸ‘¤ <span>My</span> Profile</h1>
    </div>

    <div id="profileMsg" class="msg"></div>

    <!-- Avatar -->
    <div class="glass-card">
      <h3 class="section-title">ðŸ“¸ Avatar</h3>
      <div class="avatar-section">
        <div class="avatar-wrapper" onclick="document.getElementById('avatarInput').click()">
          <div id="avatarDisplay"></div>
          <div class="avatar-overlay">ðŸ“· Change</div>
        </div>
        <p class="avatar-hint">Click to upload a new avatar</p>
        <input type="file" id="avatarInput" accept="image/*" style="display:none" />
      </div>
    </div>

    <!-- Personal Info -->
    <div class="glass-card">
      <h3 class="section-title">âœ¨ Personal Info</h3>
      <div class="form-group"><label>Username</label><input type="text" id="username" /></div>
      <div class="form-group"><label>Display Name</label><input type="text" id="displayName" placeholder="How you want to be known..." /></div>
      <div class="form-group"><label>Email</label><input type="email" id="email" /></div>
      <div class="form-actions"><button class="btn btn-primary" onclick="saveProfile()">ðŸ’¾ Save Changes</button></div>
    </div>

    <!-- Password -->
    <div class="glass-card" id="password">
      <h3 class="section-title">ðŸ”’ Change Password</h3>
      <div class="form-group"><label>Current Password</label><input type="password" id="currentPw" /></div>
      <div class="form-group"><label>New Password</label><input type="password" id="newPw" placeholder="Min 8 characters" />
        <div class="pw-requirements" id="pw-requirements">
          <div class="pw-req" id="req-length">âœ— At least 8 characters</div>
          <div class="pw-req" id="req-upper">âœ— Contains uppercase letter</div>
          <div class="pw-req" id="req-lower">âœ— Contains lowercase letter</div>
          <div class="pw-req" id="req-number">âœ— Contains a number</div>
        </div>
      </div>
      <div class="form-group"><label>Confirm New Password</label><input type="password" id="confirmPw" />
        <div class="pw-match-error" id="pw-match-error">Passwords don't match</div>
      </div>
      <div class="form-actions"><button class="btn btn-primary" onclick="changePassword()">ðŸ”‘ Update Password</button></div>
    </div>

    <!-- Theme -->
    <div class="glass-card">
      <h3 class="section-title">ðŸŽ¨ Theme Preference</h3>
      <p style="font-size:.82rem;color:var(--muted);margin-bottom:.8rem">Choose your vibe. Because DevOps should look good. ðŸ’…</p>
      <div class="theme-options">
        <div class="theme-option selected" data-theme="dark-purple" style="background:linear-gradient(135deg,#0f172a,#1e1b4b)" onclick="selectTheme(this)"><div class="theme-check">âœ“</div></div>
        <div class="theme-option" data-theme="dark-teal" style="background:linear-gradient(135deg,#0f172a,#134e4a)" onclick="selectTheme(this)"><div class="theme-check">âœ“</div></div>
        <div class="theme-option" data-theme="dark-rose" style="background:linear-gradient(135deg,#0f172a,#4a1942)" onclick="selectTheme(this)"><div class="theme-check">âœ“</div></div>
        <div class="theme-option" data-theme="midnight" style="background:linear-gradient(135deg,#0a0a0a,#1a1a2e)" onclick="selectTheme(this)"><div class="theme-check">âœ“</div></div>
      </div>
    </div>
  </main>

  <script>
    const TOKEN = localStorage.getItem('token');
    const H = () => ({ 'Authorization': `Bearer ${TOKEN}`, 'Content-Type': 'application/json' });

    function showMsg(text, type) {
      const el = document.getElementById('profileMsg');
      el.textContent = text;
      el.className = 'msg ' + type;
      setTimeout(() => el.className = 'msg', 4000);
    }

    async function loadProfile() {
      try {
        const r = await fetch('/api/profile', { headers: H() });
        const p = await r.json();
        document.getElementById('username').value = p.Username || '';
        document.getElementById('displayName').value = p.DisplayName || '';
        document.getElementById('email').value = p.Email || '';
        const display = document.getElementById('avatarDisplay');
        if (p.AvatarPath) {
          display.innerHTML = `<img src="${p.AvatarPath}" alt="Avatar" />`;
        } else {
          const initials = (p.DisplayName || p.Username || '?').substring(0, 2).toUpperCase();
          display.innerHTML = `<div class="avatar-placeholder">${initials}</div>`;
        }
        // Load theme preference
        const savedTheme = localStorage.getItem('theme') || 'dark-purple';
        document.querySelectorAll('.theme-option').forEach(t => t.classList.toggle('selected', t.dataset.theme === savedTheme));
      } catch(e) { console.error(e); }
    }

    async function saveProfile() {
      try {
        const body = {
          username: document.getElementById('username').value,
          displayName: document.getElementById('displayName').value,
          email: document.getElementById('email').value,
        };
        const r = await fetch('/api/profile', { method: 'PUT', headers: H(), body: JSON.stringify(body) });
        const data = await r.json();
        showMsg(data.message || 'Profile updated! âœ¨', r.ok ? 'success' : 'error');
      } catch(e) { showMsg('Failed to save profile', 'error'); }
    }

    // Password requirements live check
    const newPwInput = document.getElementById('newPw');
    const confirmPwInput = document.getElementById('confirmPw');
    const preqsDiv = document.getElementById('pw-requirements');
    const preqs = {
      length: { el: document.getElementById('req-length'), test: v => v.length >= 8 },
      upper:  { el: document.getElementById('req-upper'),  test: v => /[A-Z]/.test(v) },
      lower:  { el: document.getElementById('req-lower'),  test: v => /[a-z]/.test(v) },
      number: { el: document.getElementById('req-number'), test: v => /[0-9]/.test(v) },
    };
    function checkPwReqs() {
      const v = newPwInput.value;
      let allMet = true;
      for (const k in preqs) {
        const met = preqs[k].test(v);
        preqs[k].el.classList.toggle('met', met);
        preqs[k].el.textContent = (met ? 'âœ“ ' : 'âœ— ') + preqs[k].el.textContent.slice(2);
        if (!met) allMet = false;
      }
      return allMet;
    }
    newPwInput.addEventListener('focus', () => preqsDiv.classList.add('visible'));
    newPwInput.addEventListener('input', checkPwReqs);
    confirmPwInput.addEventListener('input', function() {
      const match = this.value === newPwInput.value;
      document.getElementById('pw-match-error').style.display = (!match && this.value.length > 0) ? 'block' : 'none';
    });

    async function changePassword() {
      const current = document.getElementById('currentPw').value;
      const newPw = document.getElementById('newPw').value;
      const confirm = document.getElementById('confirmPw').value;
      if (!checkPwReqs()) return showMsg('Password does not meet all requirements', 'error');
      if (newPw !== confirm) return showMsg('Passwords don\'t match! ðŸ¤”', 'error');
      try {
        const r = await fetch('/api/profile/password', { method: 'PUT', headers: H(), body: JSON.stringify({ currentPassword: current, newPassword: newPw }) });
        const data = await r.json();
        showMsg(data.message || 'Password updated!', r.ok ? 'success' : 'error');
        if (r.ok) { document.getElementById('currentPw').value=''; document.getElementById('newPw').value=''; document.getElementById('confirmPw').value=''; }
      } catch(e) { showMsg('Failed to change password', 'error'); }
    }

    // Avatar upload
    document.getElementById('avatarInput').addEventListener('change', async function() {
      const file = this.files[0];
      if (!file) return;
      const formData = new FormData();
      formData.append('avatar', file);
      try {
        const r = await fetch('/api/profile/avatar', {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${TOKEN}` },
          body: formData
        });
        const data = await r.json();
        if (r.ok) { showMsg('Avatar updated! Looking good! ðŸ˜Ž', 'success'); loadProfile(); }
        else showMsg(data.message || 'Upload failed', 'error');
      } catch(e) { showMsg('Failed to upload avatar', 'error'); }
    });

    function selectTheme(el) {
      document.querySelectorAll('.theme-option').forEach(t => t.classList.remove('selected'));
      el.classList.add('selected');
      localStorage.setItem('theme', el.dataset.theme);
      showMsg('Theme saved! Refresh for full effect. ðŸŽ¨', 'success');
    }

    // Scroll to password section if hash
    if (window.location.hash === '#password') {
      setTimeout(() => document.getElementById('password').scrollIntoView({ behavior: 'smooth' }), 500);
    }

    loadProfile();
  </script>
</body>
</html>
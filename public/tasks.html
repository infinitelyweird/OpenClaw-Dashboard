<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Tasks - Infinitely Weird DevOps</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Space+Grotesk:wght@500;600&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="styles.css" />
    <link rel="stylesheet" href="nav.css" />
    <style>
      .tab-bar { display: flex; gap: 0.5rem; margin-bottom: 1.5rem; flex-wrap: wrap; }
      .tab-btn { border: 1px solid var(--border); border-radius: 12px; padding: 0.5rem 1.2rem; background: transparent; color: var(--text); cursor: pointer; font-family: inherit; font-size: 0.9rem; transition: all 0.2s; }
      .tab-btn.active { background: linear-gradient(120deg, #c084fc, #60a5fa, #34d399); color: var(--bg); font-weight: 600; border-color: transparent; }
      .tab-content { display: none; }
      .tab-content.active { display: block; }

      .filter-bar { display: flex; gap: 0.75rem; margin-bottom: 1.5rem; flex-wrap: wrap; align-items: center; }
      .filter-bar select, .filter-bar input { border-radius: 10px; border: 1px solid rgba(255,255,255,0.2); padding: 0.4rem 0.7rem; background: rgba(5,6,10,0.4); color: var(--text); font-size: 0.85rem; font-family: inherit; }

      .task-row { display: flex; align-items: center; justify-content: space-between; padding: 1rem; border-bottom: 1px solid rgba(255,255,255,0.08); gap: 1rem; flex-wrap: wrap; }
      .task-row:last-child { border-bottom: none; }
      .task-info { flex: 1; min-width: 200px; }
      .task-info h4 { margin: 0; font-size: 1rem; }
      .task-info p { margin: 0.2rem 0 0; color: var(--muted); font-size: 0.85rem; }

      .action-btns { display: flex; gap: 0.4rem; flex-wrap: wrap; }
      .btn-sm { border: none; border-radius: 10px; padding: 0.4rem 0.9rem; font-size: 0.8rem; font-weight: 600; font-family: inherit; cursor: pointer; transition: transform 0.15s; }
      .btn-sm:hover { transform: translateY(-1px); }
      .btn-edit { background: var(--accent); color: var(--bg); }
      .btn-delete { background: var(--danger); color: #fff; }
      .btn-add { background: linear-gradient(120deg, #c084fc, #60a5fa); color: var(--bg); }
      .btn-tag { background: rgba(167,139,250,0.3); color: #c4b5fd; }

      .badge { display: inline-block; padding: 0.15rem 0.5rem; border-radius: 8px; font-size: 0.75rem; margin: 0.1rem; }
      .badge-status-open { background: rgba(96,165,250,0.25); color: #93bbfd; }
      .badge-status-in-progress, .badge-status-in_progress { background: rgba(251,191,36,0.25); color: #fcd34d; }
      .badge-status-done, .badge-status-completed, .badge-status-closed { background: rgba(52,211,153,0.25); color: #6ee7b7; }
      .badge-priority-high, .badge-priority-critical { background: rgba(239,68,68,0.25); color: #fca5a5; }
      .badge-priority-medium { background: rgba(251,191,36,0.25); color: #fcd34d; }
      .badge-priority-low { background: rgba(52,211,153,0.25); color: #6ee7b7; }
      .badge-tag { background: rgba(167,139,250,0.25); color: #c4b5fd; }

      .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(8px); display: flex; align-items: center; justify-content: center; z-index: 100; }
      .modal { background: rgba(20,20,30,0.95); border: 1px solid var(--border); border-radius: 24px; padding: 2rem; max-width: 550px; width: 90%; backdrop-filter: blur(18px); }
      .modal h3 { margin-top: 0; }
      .modal label { display: block; margin-top: 0.8rem; font-size: 0.85rem; color: var(--muted); }
      .modal input, .modal select, .modal textarea { width: 100%; box-sizing: border-box; margin-top: 0.3rem; padding: 0.5rem; border-radius: 10px; border: 1px solid rgba(255,255,255,0.2); background: rgba(5,6,10,0.4); color: var(--text); font-family: inherit; font-size: 0.9rem; }
      .modal textarea { min-height: 80px; resize: vertical; }
      .modal-actions { display: flex; gap: 0.5rem; margin-top: 1.2rem; justify-content: flex-end; }

      .tag-row { display: flex; align-items: center; justify-content: space-between; padding: 0.6rem 1rem; border-bottom: 1px solid rgba(255,255,255,0.08); }
      .tag-row:last-child { border-bottom: none; }

      .empty-state { text-align: center; color: var(--muted); padding: 2rem; }
    </style>
  </head>
  <body>
    <div class="gradient-bg"></div>
    <script src="nav.js"></script>
    <main id="app">
      <header style="margin-bottom:1.5rem;">
        <p class="eyebrow">Task Management</p>
        <h1 style="margin:0.1rem 0 0; font-size:2rem;">Tasks</h1>
      </header>

      <div class="tab-bar">
        <button class="tab-btn active" data-tab="tasks">âœ… Tasks</button>
        <button class="tab-btn" data-tab="tags">ğŸ·ï¸ Tags</button>
      </div>

      <!-- TASKS TAB -->
      <section id="tab-tasks" class="tab-content active">
        <div class="filter-bar">
          <select id="filter-status">
            <option value="">All Statuses</option>
            <option value="Open">Open</option>
            <option value="In Progress">In Progress</option>
            <option value="Done">Done</option>
            <option value="Closed">Closed</option>
          </select>
          <select id="filter-priority">
            <option value="">All Priorities</option>
            <option value="Low">Low</option>
            <option value="Medium">Medium</option>
            <option value="High">High</option>
            <option value="Critical">Critical</option>
          </select>
          <select id="filter-tag">
            <option value="">All Tags</option>
          </select>
          <button class="btn-sm btn-add" onclick="openTaskModal()">+ New Task</button>
        </div>
        <div class="glass-card" id="tasks-list">
          <div class="empty-state">Loading tasks...</div>
        </div>
      </section>

      <!-- TAGS TAB -->
      <section id="tab-tags" class="tab-content">
        <div class="glass-card">
          <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:1rem;">
            <h2 style="margin:0;">Tags</h2>
            <button class="btn-sm btn-add" onclick="openTagModal()">+ New Tag</button>
          </div>
          <div id="tags-list"><div class="empty-state">Loading tags...</div></div>
        </div>
      </section>
    </main>

    <!-- Task Modal -->
    <div id="task-modal" class="modal-overlay" style="display:none;" onclick="if(event.target===this)closeTaskModal()">
      <div class="modal">
        <h3 id="task-modal-title">New Task</h3>
        <input type="hidden" id="task-id" />
        <label>Title *
          <input type="text" id="task-title" placeholder="Task title" />
        </label>
        <label>Description
          <textarea id="task-desc" placeholder="Optional description"></textarea>
        </label>
        <label>Status
          <select id="task-status">
            <option value="Open">Open</option>
            <option value="In Progress">In Progress</option>
            <option value="Done">Done</option>
            <option value="Closed">Closed</option>
          </select>
        </label>
        <label>Priority
          <select id="task-priority">
            <option value="Low">Low</option>
            <option value="Medium" selected>Medium</option>
            <option value="High">High</option>
            <option value="Critical">Critical</option>
          </select>
        </label>
        <label>Assign To
          <select id="task-assigned"><option value="">Unassigned</option></select>
        </label>
        <div class="modal-actions">
          <button class="btn-sm" style="background:rgba(255,255,255,0.15);color:var(--text);" onclick="closeTaskModal()">Cancel</button>
          <button class="btn-sm btn-add" onclick="saveTask()">Save</button>
        </div>
      </div>
    </div>

    <!-- Tag Modal -->
    <div id="tag-modal" class="modal-overlay" style="display:none;" onclick="if(event.target===this)closeTagModal()">
      <div class="modal">
        <h3>New Tag</h3>
        <label>Tag Name *
          <input type="text" id="tag-name" placeholder="e.g. bug, feature, urgent" />
        </label>
        <div class="modal-actions">
          <button class="btn-sm" style="background:rgba(255,255,255,0.15);color:var(--text);" onclick="closeTagModal()">Cancel</button>
          <button class="btn-sm btn-add" onclick="saveTag()">Create</button>
        </div>
      </div>
    </div>

    <!-- Tag Assignment Modal -->
    <div id="tag-assign-modal" class="modal-overlay" style="display:none;" onclick="if(event.target===this)closeTagAssignModal()">
      <div class="modal">
        <h3>Manage Tags</h3>
        <p style="color:var(--muted);font-size:0.85rem;" id="tag-assign-task-name"></p>
        <div id="tag-assign-list"></div>
        <div class="modal-actions">
          <button class="btn-sm" style="background:rgba(255,255,255,0.15);color:var(--text);" onclick="closeTagAssignModal()">Close</button>
        </div>
      </div>
    </div>

    <script>
      const token = localStorage.getItem('token');
      const headers = { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' };
      let allTags = [];
      let allUsers = [];

      // â”€â”€â”€ Tabs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
          btn.classList.add('active');
          document.getElementById('tab-' + btn.dataset.tab).classList.add('active');
        });
      });

      // â”€â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      async function init() {
        await Promise.all([loadTags(), loadUsers()]);
        populateFilterTags();
        loadTasks();
      }

      // â”€â”€â”€ Tasks â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      async function loadTasks() {
        const params = new URLSearchParams();
        const s = document.getElementById('filter-status').value;
        const p = document.getElementById('filter-priority').value;
        const t = document.getElementById('filter-tag').value;
        if (s) params.set('status', s);
        if (p) params.set('priority', p);
        if (t) params.set('tag', t);

        try {
          const res = await fetch('/api/tasks?' + params.toString(), { headers });
          const tasks = await res.json();
          const container = document.getElementById('tasks-list');
          if (!tasks.length) {
            container.innerHTML = '<div class="empty-state">No tasks found.</div>';
            return;
          }
          container.innerHTML = tasks.map(t => {
            const statusClass = 'badge-status-' + (t.Status || '').toLowerCase().replace(/\s+/g, '-');
            const prioClass = 'badge-priority-' + (t.Priority || '').toLowerCase();
            const tags = t.Tags ? t.Tags.split(', ').map(tg => `<span class="badge badge-tag">${esc(tg)}</span>`).join('') : '';
            return `<div class="task-row">
              <div class="task-info">
                <h4>${esc(t.Title)}</h4>
                <p>${esc(t.Description || '')}</p>
                <div style="margin-top:0.4rem;">
                  <span class="badge ${statusClass}">${esc(t.Status)}</span>
                  <span class="badge ${prioClass}">${esc(t.Priority)}</span>
                  ${tags}
                  ${t.AssignedToName ? `<span style="color:var(--muted);font-size:0.75rem;margin-left:0.5rem;">â†’ ${esc(t.AssignedToName)}</span>` : ''}
                </div>
              </div>
              <div class="action-btns">
                <button class="btn-sm btn-tag" onclick="openTagAssignModal(${t.TaskID}, '${esc(t.Title)}')">ğŸ·ï¸</button>
                <button class="btn-sm btn-edit" onclick="editTask(${t.TaskID})">Edit</button>
                <button class="btn-sm btn-delete" onclick="deleteTask(${t.TaskID})">Delete</button>
              </div>
            </div>`;
          }).join('');
        } catch (err) {
          console.error(err);
          document.getElementById('tasks-list').innerHTML = '<div class="empty-state">Failed to load tasks.</div>';
        }
      }

      // Filters
      document.getElementById('filter-status').addEventListener('change', loadTasks);
      document.getElementById('filter-priority').addEventListener('change', loadTasks);
      document.getElementById('filter-tag').addEventListener('change', loadTasks);

      // â”€â”€â”€ Task Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      function openTaskModal(task) {
        document.getElementById('task-modal-title').textContent = task ? 'Edit Task' : 'New Task';
        document.getElementById('task-id').value = task ? task.TaskID : '';
        document.getElementById('task-title').value = task ? task.Title : '';
        document.getElementById('task-desc').value = task ? (task.Description || '') : '';
        document.getElementById('task-status').value = task ? task.Status : 'Open';
        document.getElementById('task-priority').value = task ? task.Priority : 'Medium';
        document.getElementById('task-assigned').value = task ? (task.AssignedTo || '') : '';
        // Populate user dropdown
        const sel = document.getElementById('task-assigned');
        sel.innerHTML = '<option value="">Unassigned</option>' + allUsers.map(u => `<option value="${u.UserID}" ${task && task.AssignedTo === u.UserID ? 'selected' : ''}>${esc(u.Username)}</option>`).join('');
        document.getElementById('task-modal').style.display = 'flex';
      }
      function closeTaskModal() { document.getElementById('task-modal').style.display = 'none'; }

      async function editTask(id) {
        const res = await fetch('/api/tasks/' + id, { headers });
        const task = await res.json();
        openTaskModal(task);
      }

      async function saveTask() {
        const id = document.getElementById('task-id').value;
        const body = {
          title: document.getElementById('task-title').value,
          description: document.getElementById('task-desc').value,
          status: document.getElementById('task-status').value,
          priority: document.getElementById('task-priority').value,
          assignedTo: document.getElementById('task-assigned').value || null,
        };
        if (!body.title) return alert('Title is required.');
        const url = id ? '/api/tasks/' + id : '/api/tasks';
        const method = id ? 'PUT' : 'POST';
        await fetch(url, { method, headers, body: JSON.stringify(body) });
        closeTaskModal();
        loadTasks();
      }

      async function deleteTask(id) {
        if (!confirm('Delete this task?')) return;
        await fetch('/api/tasks/' + id, { method: 'DELETE', headers });
        loadTasks();
      }

      // â”€â”€â”€ Tags â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      async function loadTags() {
        const res = await fetch('/api/tags', { headers });
        allTags = await res.json();
        renderTags();
      }

      function renderTags() {
        const container = document.getElementById('tags-list');
        if (!allTags.length) {
          container.innerHTML = '<div class="empty-state">No tags yet.</div>';
          return;
        }
        container.innerHTML = allTags.map(t => `<div class="tag-row">
          <span class="badge badge-tag">${esc(t.TagName)}</span>
          <button class="btn-sm btn-delete" onclick="deleteTag(${t.TagID})">Delete</button>
        </div>`).join('');
      }

      function populateFilterTags() {
        const sel = document.getElementById('filter-tag');
        sel.innerHTML = '<option value="">All Tags</option>' + allTags.map(t => `<option value="${esc(t.TagName)}">${esc(t.TagName)}</option>`).join('');
      }

      function openTagModal() { document.getElementById('tag-name').value = ''; document.getElementById('tag-modal').style.display = 'flex'; }
      function closeTagModal() { document.getElementById('tag-modal').style.display = 'none'; }

      async function saveTag() {
        const tagName = document.getElementById('tag-name').value.trim();
        if (!tagName) return alert('Tag name is required.');
        await fetch('/api/tags', { method: 'POST', headers, body: JSON.stringify({ tagName }) });
        closeTagModal();
        await loadTags();
        populateFilterTags();
      }

      async function deleteTag(id) {
        if (!confirm('Delete this tag?')) return;
        const res = await fetch('/api/tags/' + id, { method: 'DELETE', headers });
        if (res.status === 403) return alert('Admin access required to delete tags.');
        await loadTags();
        populateFilterTags();
        loadTasks();
      }

      // â”€â”€â”€ Tag Assignment â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      let tagAssignTaskId = null;
      function openTagAssignModal(taskId, title) {
        tagAssignTaskId = taskId;
        document.getElementById('tag-assign-task-name').textContent = 'Task: ' + title;
        document.getElementById('tag-assign-modal').style.display = 'flex';
        loadTagAssignments();
      }
      function closeTagAssignModal() { document.getElementById('tag-assign-modal').style.display = 'none'; tagAssignTaskId = null; }

      async function loadTagAssignments() {
        const res = await fetch('/api/tasks/' + tagAssignTaskId, { headers });
        const task = await res.json();
        const assignedIds = (task.tags || []).map(t => t.TagID);
        const container = document.getElementById('tag-assign-list');
        container.innerHTML = allTags.map(t => {
          const assigned = assignedIds.includes(t.TagID);
          return `<div class="tag-row">
            <span class="badge badge-tag">${esc(t.TagName)}</span>
            <button class="btn-sm ${assigned ? 'btn-delete' : 'btn-add'}" onclick="toggleTag(${tagAssignTaskId}, ${t.TagID}, ${assigned})">${assigned ? 'Remove' : 'Add'}</button>
          </div>`;
        }).join('') || '<div class="empty-state">No tags available. Create some first!</div>';
      }

      async function toggleTag(taskId, tagId, remove) {
        const method = remove ? 'DELETE' : 'POST';
        await fetch(`/api/tasks/${taskId}/tags/${tagId}`, { method, headers });
        loadTagAssignments();
        loadTasks();
      }

      // â”€â”€â”€ Users â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      async function loadUsers() {
        try {
          const res = await fetch('/api/tasks/users/list', { headers });
          allUsers = await res.json();
        } catch { allUsers = []; }
      }

      // â”€â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      function esc(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

      init();
    </script>
  </body>
</html>
